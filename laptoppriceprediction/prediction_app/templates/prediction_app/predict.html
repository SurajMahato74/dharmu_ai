{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="min-h-screen bg-gradient-to-br from-violet-50 via-purple-50 to-pink-50 py-12 px-4">
  <div class="max-w-7xl mx-auto">

    <!-- Hero Section -->
    <div class="text-center mb-12 relative">
      <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-4">
        Laptop Price Prediction
      </h1>
      <p class="text-xl text-gray-700 max-w-3xl mx-auto">
        Fill as little or as much as you want ‚Äî even <span class="font-bold text-purple-600">one field</span> is enough!
      </p>
      
      <!-- Chat History Button -->
      <button id="chatToggle" class="fixed top-6 right-6 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-2xl transition-all z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        {% if recent_predictions %}<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">{{ recent_predictions }}</span>{% endif %}
      </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-3xl shadow-2xl p-10 text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-8 border-purple-200 border-t-purple-600 mx-auto mb-4"></div>
        <p class="text-2xl font-bold text-purple-700">Predicting the best price...</p>
      </div>
    </div>

    <!-- Configuration Card -->
    <div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl p-6 border border-purple-100">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Choose Your Specs</h2>
        <span class="text-sm font-medium text-red-600 bg-red-100 px-3 py-1 rounded-full">
          Brand + 1 more field required
        </span>
      </div>

      <form id="laptopForm" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">

        {% csrf_token %}

        <!-- Brand -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Brand <span class="text-red-500">*</span></label>
          <select name="brand" id="brand" class="w-full px-3 py-2 rounded-lg border border-red-300 focus:ring-2 focus:ring-purple-400 focus:border-purple-500 transition-all text-sm" required>
            <option value="">Select Brand (Required)</option>
            <option value="">Any Brand</option>
            <option value="HP">HP</option>
            <option value="Dell">Dell</option>
            <option value="Lenovo">Lenovo</option>
            <option value="Asus">Asus</option>
            <option value="Acer">Acer</option>
            <option value="Apple">Apple</option>
            <option value="MSI">MSI</option>
            <option value="Samsung">Samsung</option>
            <option value="Infinix">Infinix</option>
            <option value="Xiaomi">Xiaomi</option>
          </select>
        </div>

        <!-- Processor -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Processor</label>
          <select name="processor" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any Processor</option>
            <option value="12th Gen Intel Core i5">12th Gen Intel Core i5</option>
            <option value="13th Gen Intel Core i7">13th Gen Intel Core i7</option>
            <option value="11th Gen Intel Core i5">11th Gen Intel Core i5</option>
            <option value="5th Gen AMD Ryzen 5">5th Gen AMD Ryzen 5</option>
            <option value="7th Gen AMD Ryzen 7">7th Gen AMD Ryzen 7</option>
            <option value="12th Gen Intel Core i7">12th Gen Intel Core i7</option>
            <option value="13th Gen Intel Core i5">13th Gen Intel Core i5</option>
            <option value="Apple M2">Apple M2</option>
          </select>
        </div>

        <!-- RAM -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">RAM (GB)</label>
          <select name="ram" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any RAM</option>
            <option value="4">4 GB</option>
            <option value="8">8 GB</option>
            <option value="16">16 GB</option>
            <option value="32">32 GB</option>
            <option value="64">64 GB</option>
          </select>
        </div>

        <!-- Storage -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Storage (GB)</label>
          <select name="storage" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any Storage</option>
            <option value="128">128 GB</option>
            <option value="256">256 GB</option>
            <option value="512">512 GB</option>
            <option value="1024">1 TB</option>
            <option value="2048">2 TB</option>
          </select>
        </div>

        <!-- Storage Type -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Storage Type</label>
          <select name="storage_type" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any Type</option>
            <option value="SSD">SSD</option>
            <option value="Hard-Disk">HDD</option>
          </select>
        </div>

        <!-- Display Size -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Screen Size (inch)</label>
          <input type="number" step="0.1" name="display_size" placeholder="15.6" min="11" max="18"
                 class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
        </div>

        <!-- Resolution -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Resolution</label>
          <select name="resolution" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any Resolution</option>
            <option value="1366x768">1366√ó768 (HD)</option>
            <option value="1920x1080">1920√ó1080 (Full HD)</option>
            <option value="2560x1440">2560√ó1440 (QHD)</option>
            <option value="3840x2160">3840√ó2160 (4K)</option>
          </select>
        </div>

        <!-- GPU -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Graphics Card</label>
          <select name="gpu" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any GPU</option>
            <option value="Intel Integrated">Intel Integrated</option>
            <option value="Intel Iris Xe">Intel Iris Xe</option>
            <option value="NVIDIA GeForce RTX 3050">RTX 3050</option>
            <option value="NVIDIA GeForce RTX 4060">RTX 4060</option>
            <option value="AMD Radeon">AMD Radeon</option>
            <option value="NVIDIA GeForce GTX 1650">GTX 1650</option>
          </select>
        </div>

        <!-- OS -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Operating System</label>
          <select name="os" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any OS</option>
            <option value="Windows 11 OS">Windows 11</option>
            <option value="Windows 10 OS">Windows 10</option>
            <option value="Mac OS">macOS</option>
            <option value="DOS OS">DOS / Linux</option>
            <option value="Chrome OS">Chrome OS</option>
          </select>
        </div>

        <!-- Weight -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Weight (kg)</label>
          <input type="number" step="0.1" name="weight" placeholder="e.g. 1.8" min="0.5" max="5"
                 class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
        </div>

        <!-- Warranty -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Warranty (years)</label>
          <select name="warranty" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 transition-all text-sm">
            <option value="">Any</option>
            <option value="1">1 Year</option>
            <option value="2">2 Years</option>
            <option value="3">3 Years</option>
          </select>
        </div>

        <!-- Spec Rating Slider -->
        <div class="xl:col-span-3">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            Overall Spec Rating: <span id="ratingValue" class="text-purple-600 font-bold text-lg">70</span>/90
          </label>
          <input type="range" name="spec_rating" id="spec_rating" min="50" max="90" value="70" step="1"
                 class="w-full h-4 bg-gray-200 rounded-full appearance-none cursor-pointer slider-thumb">
        </div>

        <!-- Predict Button -->
        <div class="col-span-full mt-6">
          <div class="flex items-center gap-4">
            <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold text-xl py-4 rounded-xl shadow-xl transform hover:scale-105 transition duration-300">
              üöÄ Predict Price
            </button>
            <select name="model_type" class="px-4 py-4 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-400 bg-white text-sm font-medium min-w-[200px]">
              <option value="best">üèÜ Best Model (Gradient Boosting)</option>
              <option value="linear">üìà Linear Regression</option>
              <option value="ridge">üìä Ridge Regression</option>
              <option value="lasso">üéØ Lasso Regression</option>
              <option value="random_forest">üå≥ Random Forest</option>
              <option value="gradient_boosting">‚ö° Gradient Boosting</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="mt-12 space-y-8" style="display: none;">
      
      <!-- Price Prediction -->
      <div class="bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-3xl shadow-2xl p-8 text-center">
        <h2 class="text-3xl font-bold mb-4">Predicted Price</h2>
        <div id="predictedPrice" class="text-6xl font-extrabold">‚Çπ0</div>
        <p class="mt-3 text-lg opacity-90">Predicted by <span id="modelUsed" class="font-bold">AI Model</span></p>
      </div>

      <!-- Configuration & Suggestions -->
      <div class="grid lg:grid-cols-2 gap-8">
        
        <!-- Configuration Summary -->
        <div class="bg-white rounded-3xl shadow-2xl p-8">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Configuration</h2>
          <div id="configSummary" class="space-y-3 text-lg"></div>
        </div>

        <!-- AI Laptop Suggestions -->
        <div class="bg-white rounded-3xl shadow-2xl p-8">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">ü§ñ AI Suggestions</h2>
          <div id="laptopSuggestions" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat History Panel -->
<div id="chatPanel" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-40 border-l">
  <div class="flex flex-col h-full">
    <!-- Header -->
    <div class="bg-purple-600 text-white p-4 flex items-center justify-between">
      <h3 class="font-bold text-lg">ü§ñ Prediction History</h3>
      <button id="closeChatPanel" class="text-white hover:text-gray-200">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Chat Messages -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
      <div class="text-center text-gray-500 py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
        Loading your prediction history...
      </div>
    </div>
  </div>
</div>

<!-- Chat Overlay -->
<div id="chatOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

<script>
// Live rating update
document.addEventListener('DOMContentLoaded', function() {
  const specRating = document.getElementById('spec_rating');
  const ratingValue = document.getElementById('ratingValue');
  
  if (specRating && ratingValue) {
    specRating.addEventListener('input', function() {
      ratingValue.textContent = this.value;
    });
  }
});

// Field counter and validation feedback
function updateFieldCounter() {
  const form = document.getElementById('laptopForm');
  if (!form) return;
  
  const formData = new FormData(form);
  const brand = formData.get('brand');
  
  let filledCount = 0;
  for (let [key, value] of formData.entries()) {
    if (value && value !== '' && key !== 'csrfmiddlewaretoken' && key !== 'model_type') {
      filledCount++;
    }
  }
  
  const statusSpan = document.querySelector('.text-red-600, .text-green-600, .text-orange-600');
  const brandSelect = document.getElementById('brand');
  
  if (!statusSpan || !brandSelect) return;
  
  if (brand && filledCount >= 2) {
    statusSpan.textContent = `‚úì Ready to predict (${filledCount} fields)`;
    statusSpan.className = 'text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full';
    brandSelect.classList.remove('border-red-300', 'border-orange-300');
    brandSelect.classList.add('border-green-300');
  } else if (brand && filledCount === 1) {
    statusSpan.textContent = 'Need 1 more field';
    statusSpan.className = 'text-sm font-medium text-orange-600 bg-orange-100 px-3 py-1 rounded-full';
    brandSelect.classList.remove('border-red-300', 'border-green-300');
    brandSelect.classList.add('border-orange-300');
  } else {
    statusSpan.textContent = 'Brand + 1 more field required';
    statusSpan.className = 'text-sm font-medium text-red-600 bg-red-100 px-3 py-1 rounded-full';
    brandSelect.classList.remove('border-green-300', 'border-orange-300');
    brandSelect.classList.add('border-red-300');
  }
}

// Add event listeners to all form inputs after DOM loads
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to all form inputs
  document.querySelectorAll('#laptopForm select, #laptopForm input').forEach(input => {
    input.addEventListener('change', updateFieldCounter);
    input.addEventListener('input', updateFieldCounter);
  });
  
  // Initial counter update
  updateFieldCounter();
});

// Chat History Functions
let chatHistory = [];

function toggleChatPanel() {
  const panel = document.getElementById('chatPanel');
  const overlay = document.getElementById('chatOverlay');
  
  if (panel.classList.contains('translate-x-full')) {
    // Open panel
    panel.classList.remove('translate-x-full');
    overlay.classList.remove('hidden');
    loadChatHistory();
  } else {
    // Close panel
    panel.classList.add('translate-x-full');
    overlay.classList.add('hidden');
  }
}

function loadChatHistory() {
  fetch('/api/prediction-history/')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        chatHistory = data.history;
        displayChatHistory();
      }
    })
    .catch(err => console.error('Error loading history:', err));
}

function displayChatHistory() {
  const container = document.getElementById('chatMessages');
  
  if (chatHistory.length === 0) {
    container.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-4">üìä</div>
        <p>No predictions yet!</p>
        <p class="text-sm">Start by making your first prediction below.</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  chatHistory.forEach(pred => {
    // User query
    const configText = Object.entries(pred.config)
      .map(([key, value]) => `${key}: ${value}`)
      .join(', ');
    
    html += `
      <div class="space-y-3">
        <!-- User Query -->
        <div class="flex justify-end">
          <div class="bg-purple-100 rounded-lg p-3 max-w-xs">
            <div class="text-sm font-medium text-purple-800">Your Query</div>
            <div class="text-sm text-gray-700">${configText}</div>
            <div class="text-xs text-gray-500 mt-1">${pred.timestamp}</div>
          </div>
        </div>
        
        <!-- AI Response -->
        <div class="flex justify-start">
          <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
            <div class="text-sm font-medium text-gray-800">ü§ñ ${pred.model_used}</div>
            <div class="text-lg font-bold text-green-600">${pred.formatted_price}</div>
            <div class="text-xs text-gray-600 mt-2 space-y-1">
              ${pred.suggestions.map(s => `<div>‚Ä¢ ${s.full_name || s.name} - ‚Çπ${s.price.toLocaleString()}</div>`).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

function addToChatHistory(predictionData) {
  // Add new prediction to local history
  const newPred = {
    timestamp: new Date().toLocaleString(),
    config: predictionData.user_config,
    model_used: predictionData.model_used,
    formatted_price: predictionData.formatted_price,
    suggestions: predictionData.laptop_suggestions
  };
  
  chatHistory.push(newPred);
  
  // Update chat if panel is open
  if (!document.getElementById('chatPanel').classList.contains('translate-x-full')) {
    displayChatHistory();
  }
  
  // Update notification badge
  const badge = document.querySelector('#chatToggle span');
  if (badge) {
    const count = parseInt(badge.textContent) + 1;
    badge.textContent = count;
  }
}

// Event Listeners - safely add after DOM loads
document.addEventListener('DOMContentLoaded', function() {
  const chatToggle = document.getElementById('chatToggle');
  const closeChatPanel = document.getElementById('closeChatPanel');
  const chatOverlay = document.getElementById('chatOverlay');
  
  if (chatToggle) chatToggle.addEventListener('click', toggleChatPanel);
  if (closeChatPanel) closeChatPanel.addEventListener('click', toggleChatPanel);
  if (chatOverlay) chatOverlay.addEventListener('click', toggleChatPanel);
});



// Field validation
function validateForm() {
  const formData = new FormData(document.getElementById('laptopForm'));
  const brand = formData.get('brand');
  
  // Count filled fields
  let filledCount = 0;
  for (let [key, value] of formData.entries()) {
    if (value && value !== '' && key !== 'csrfmiddlewaretoken' && key !== 'model_type') {
      filledCount++;
    }
  }
  
  if (!brand || brand === '') {
    alert('Please select a brand to get accurate predictions');
    return false;
  }
  
  if (filledCount < 2) {
    alert('Please fill at least 2 fields including brand for better predictions');
    return false;
  }
  
  return true;
}

// Form Submit - safely add after DOM loads
document.addEventListener('DOMContentLoaded', function() {
  const laptopForm = document.getElementById('laptopForm');
  if (!laptopForm) return;
  
  laptopForm.addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!validateForm()) {
    return;
  }

  document.getElementById('loading').classList.remove('hidden');

  const formData = new FormData(this);
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Convert FormData to JSON
  const jsonData = {};
  for (let [key, value] of formData.entries()) {
    if (key !== 'csrfmiddlewaretoken') {
      jsonData[key] = value;
    }
  }

  fetch('/api/predict-price/', {
    method: 'POST',
    body: JSON.stringify(jsonData),
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken 
    }
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('loading').classList.add('hidden');

    if (data.success) {
      document.getElementById('resultsSection').style.display = 'grid';
      document.getElementById('predictedPrice').textContent = data.formatted_price;
      document.getElementById('modelUsed').textContent = data.model_used || 'AI Model';

      // Show configuration summary
      let summary = '';
      const config = data.user_config || {};
      const importantFields = ['brand', 'processor', 'ram', 'storage', 'gpu', 'os'];
      
      importantFields.forEach(field => {
        if (config[field]) {
          const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          let value = config[field];
          if (field === 'ram') value += ' GB';
          if (field === 'storage') value += ' GB';
          summary += `<div class="flex justify-between border-b pb-2"><span class="font-medium text-gray-600">${label}:</span> <strong class="text-purple-600">${value}</strong></div>`;
        }
      });
      document.getElementById('configSummary').innerHTML = summary || '<p class="text-gray-500">Using default configuration</p>';

      // Show laptop suggestions
      let suggestionsHtml = '';
      const suggestions = data.laptop_suggestions || [];
      suggestions.forEach((laptop, index) => {
        const colors = ['bg-blue-50 border-blue-200', 'bg-green-50 border-green-200', 'bg-purple-50 border-purple-200'];
        suggestionsHtml += `
          <div class="${colors[index]} border-2 rounded-xl p-4">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="font-bold text-lg text-gray-800">${laptop.full_name || laptop.name}</h3>
                <p class="text-sm text-purple-600 font-medium">${laptop.category}</p>
              </div>
              <span class="text-2xl font-bold text-green-600">‚Çπ${laptop.price.toLocaleString()}</span>
            </div>
            <div class="bg-white/70 rounded-lg p-3 mb-2">
              <div class="text-sm font-mono text-gray-700">${laptop.specs}</div>
            </div>
            <p class="text-sm text-gray-600">${laptop.details}</p>
          </div>
        `;
      });
      document.getElementById('laptopSuggestions').innerHTML = suggestionsHtml || '<p class="text-gray-500">No suggestions available</p>';

      // Smooth scroll to results
      setTimeout(() => {
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
      }, 100);
      
      // Add to chat history
      addToChatHistory(data);
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(err => {
    document.getElementById('loading').classList.add('hidden');
    alert('Network error. Please check your connection and try again!');
  });
  
  // Load initial chat history on page load
  loadChatHistory();
});
});
</script>

<style>
  .slider-thumb::-webkit-slider-thumb {
    appearance: none;
    height: 32px;
    width: 32px;
    border-radius: 50%;
    background: linear-gradient(to right, #a855f7, #ec4899);
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
  }
  .slider-thumb::-moz-range-thumb {
    height: 32px;
    width: 32px;
    border-radius: 50%;
    background: linear-gradient(to right, #a855f7, #ec4899);
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
  }
</style>

{% endblock %}